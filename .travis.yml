jobs:
  include:
    - name: python3.8
      language: python
      python: "3.8"
    - name: python3.7
      language: python
      python: "3.7"
    - name: python3.6
      language: python
      python: "3.6"
    - name: conda

script:
# basic install (no requirements)
  - if [ "$TRAVIS_JOB_NAME" != conda ] ; then
      pip install --no-deps . &&
      python -c "import bussilab" &&
      bussilab -h &&
      pip uninstall --yes bussilab ;
    fi

# full install (with requirements)
  - if [ "$TRAVIS_JOB_NAME" != conda ] ; then
      pip install --upgrade . ;
  - else
       curl -LO https://raw.githubusercontent.com/GiovanniBussi/conda-ci/master/conda-ci &&
       source ./conda-ci install &&
       source ./conda-ci install-conda-build &&
       export CPU_COUNT=4 &&
       conda-build -c conda-forge conda &&
       conda install -c conda-forge bussilab
    fi

# check if module can be imported
  - bussilab check --import ;

# in the following, use either conda or pip
  - if [ "$TRAVIS_JOB_NAME" = conda ] ; then
      install="conda install -c conda-forge" ;
    else
      install="pip install --upgrade" ;
    fi

# run test suite
  - $install pytest pytest-cov &&
    PYTHONPATH=. py.test --cov=./
# pyflakes
  - $install pyflakes &&
    pyflakes bussilab
# mypy
  - $install mypy &&
    mypy bussilab
# pylint (ignore, too many false positives)
  - $install pylint &&
    pylint bussilab || echo ignore
# build doc
  - $install pdoc3 &&
    pdoc3 -f --html -o doc/ bussilab
# render notebooks
  - $install jupyter nbconvert &&
    ( cd examples && ./render.sh ) &&
    mkdir doc/examples &&
    cp examples/*html doc/examples/ &&
    ( sudo apt-get install tree && cd doc/examples && tree -H '.' -L 1 --noreport --charset utf-8 > index.html )

# fail if tag is inconsistent with version
  - if [ -n "$TRAVIS_TAG" ] ; then test v$(bussilab --version) == "$TRAVIS_TAG" ; fi

after_success:
  - if [ "${TRAVIS_JOB_NUMBER#*.}" = 1 ] && [ "$TRAVIS_BRANCH" = master ] ; then .travis/pushdoc ; fi
  - if [ "${TRAVIS_JOB_NUMBER#*.}" = 1 ] && [ -n "$TRAVIS_TAG" ] ; then
        pip install twine &&
        python setup.py sdist &&
        python -m twine upload -u bussilabbot -p "$BUSSILABBOT_PYPI" dist/bussilab-*.tar.gz ;
    fi
  - bash <(curl -s https://codecov.io/bash)
