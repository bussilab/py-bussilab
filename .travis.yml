language: python

python:
  - "3.8"
  - "3.7"
  - "3.6"

cache: pip

script:
# basic install (no requirements)
  - pip install --no-deps . &&
    python -c "import bussilab" &&
    bussilab -h
  - pip uninstall --yes bussilab
# full install (with requirements)
  - pip install --upgrade . &&
    bussilab check --import
# run test suite
  - pip install --upgrade pytest pytest-cov &&
    PYTHONPATH=. py.test --cov=./
# pyflakes
  - pip install --upgrade pyflakes &&
    pyflakes bussilab
# mypy
  - pip install --upgrade mypy &&
    mypy bussilab
# pylint (ignore, too many false positives)
  - pip install --upgrade pylint &&
    pylint bussilab || echo ignore
# build doc
  - pip install --upgrade pdoc3 &&
    pdoc3 -f --html -o doc/ bussilab

after_success:
  - if [ "${TRAVIS_JOB_NUMBER#*.}" = 1 ] && [ "$TRAVIS_BRANCH" = master ] ; then .travis/pushdoc ; fi
  - bash <(curl -s https://codecov.io/bash)
  - if [ "${TRAVIS_JOB_NUMBER#*.}" = 1 ] && [ -n "$TRAVIS_TAG" ] ; then
        test v$(bussilab --version) == "$TRAVIS_TAG" &&
        pip install twine &&
        python setup.py sdist &&
        python -m twine upload -u bussilabbot -p "$BUSSILABBOT_PYPI" dist/bussilab-*.tar.gz
    fi
